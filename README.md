# 微店订单自动化导出工具 (V2 - 高性能重构版)

本项目是一个使用Python实现的高性能、高健壮性的自动化工具。它通过解耦的、多线程的架构，实现了对微店订单数据的高速采集、并行截图处理，并将最终结果存入数据库，导出为格式精美的Excel报告。

相较于V1版本，V2版本在**性能、稳定性、可维护性**上都进行了革命性的重构。

---

## ✨ V2版本核心特性

- **三阶段解耦架构**:
    1.  **采集 (`collector.py`)**: 高速捕获XHR请求，将原始订单数据快速存入SQLite数据库。
    2.  **处理 (`screenshotter.py`)**: 从数据库读取任务，使用多线程和WebDriver池并行处理截图。
    3.  **导出 (`export.py`)**: 从数据库读取已完成的数据，生成最终的图文并茂的Excel报告。
- **卓越性能**:
    - 通过多线程并行处理，截图效率相较于V1版本的线性流程**提升数倍**。
    - 使用SQLite作为数据中心，数据读写速度远超传统的文件I/O。
- **工业级健壮性**:
    - **断点续传**: 所有任务进度持久化在数据库中。程序可随时中断和重启，绝不会丢失进度。
    - **任务自动修复**: 启动时自动重置因意外中断而产生的“正在运行”的任务，保证100%的任务执行率。
    - **动态实例再生**: WebDriver实例（浏览器）被视为消耗品，拥有“生命周期”。系统会自动销毁并重建可能不稳定的旧实例，从根本上避免了因内存泄漏或资源污染导致的长时间运行崩溃。
- **高度可配置**:
    - 可灵活配置采集深度、并发线程数、WebDriver实例生命周期等核心参数。

---

## 🚀 快速开始

### 1. 环境准备

本项目依赖 Python 3 环境 (推荐 3.11+)。首先，请在虚拟环境中安装所有必需的库。

```bash
pip install -r requirements.txt
```

*`requirements.txt` 文件内容:*
```
selenium-wire
webdriver-manager
pandas
xlsxwriter
Pillow
openpyxl
```

### 2. 完整执行流程 (三步走)

请严格按照以下顺序，依次执行三个独立的脚本。

#### **第1步: 运行数据采集器 (`collector.py`)**

此脚本负责将订单的文字信息抓取到本地的`tasks.db`数据库文件中。

- **配置**: 打开 `collector.py`，在文件底部的`if __name__ == "__main__":`部分，填入最新的`MY_COOKIE`和`CLICKS_TO_PERFORM`（抓取页数）。
- **执行**:
  ```bash
  python collector.py
  ```
- **产出**: 在项目根目录下生成一个 `tasks.db` 文件。

#### **第2步: 运行并行截图器 (`screenshotter.py`)**

此脚本将从`tasks.db`中读取任务，并启动多个浏览器实例并行截图。

- **配置**: 打开 `screenshotter.py`，在文件顶部的“用户配置区”：
    - 填入最新的 `MY_COOKIE`。
    - 根据您的电脑性能，设置 `WORKER_THREADS` (工人线程数) 和 `MAX_DRIVERS_IN_POOL` (浏览器实例数)。**建议将两者设为相同的值**，如`4`或`6`。
    - (可选) 调整 `DRIVER_MAX_USE_COUNT` (每个浏览器实例的最大使用次数)。
- **执行**: (建议在执行大规模任务前，先清理WebDriver缓存: `rm -rf ~/.wdm`)
  ```bash
  python screenshotter.py
  ```
- **产出**: 在`screenshots`文件夹中生成大量截图，并更新`tasks.db`文件中的任务状态。

#### **第3步: 运行报告生成器 (`export.py`)**

此脚本负责读取数据库中所有已完成的任务，生成最终的Excel文件。

- **配置**: (可选) 打开 `export.py`，修改`OUTPUT_FILENAME`变量以自定义输出文件名。
- **执行**:
  ```bash
  python export.py
  ```
- **产出**: 在项目根目录下生成最终的 `.xlsx` 报告文件，例如 `微店订单导出_V2.xlsx`。

---

## 🛠️ 架构设计概览

V2版本的核心是**生产者-消费者模型**和**数据持久化**。

- **`collector.py` (生产者)**: 快速生产“任务”（订单数据），并将其放入“仓库”（`tasks.db`数据库）。
- **`screenshotter.py` (消费者集群)**:
    - **总工头 (主线程)**: 负责初始化资源（WebDriver池）和分派工人。
    - **工人 (Worker Threads)**: 从“仓库”中安全地领取任务，使用共享的“工具”（WebDriver实例）进行加工（截图）。
    - **记账员 (Writer Thread)**: 将工人们完成的“工作成果”（成功路径或失败信息）统一、安全地记录回“仓库”。
- **`export.py` (报告员)**: 在所有工作完成后，对“仓库”中所有已完成的“成品”进行盘点，并生成一份精美的报告。

这种设计确保了每个组件职责单一，系统健壮，且易于维护和扩展。