# 微店订单自动化导出工具

本项目是一个使用 Python 和 Selenium 实现的自动化工具，旨在从微店网页版抓取指定账号的订单信息，并将结果（包含订单详情截图）导出为格式化的 Excel 文件。

---

## ✨ 功能特性

- **自动化登录**：通过注入Cookie实现免密登录，安全便捷。
- **高速数据采集**：采用纯JSON请求捕获技术，避免了缓慢且不稳定的页面解析，实现了“光速”般的数据抓取。
- **精准截图**：自动访问每个订单的详情页，通过页面缩放和图像裁剪技术，生成干净、信息集中的订单截图。
- **完美Excel导出**：
    - 将所有采集到的数据（包括商品名、规格、订单状态等）写入`.xlsx`文件。
    - 将处理过的截图**嵌入**到Excel中，并锚定在对应订单的单元格。
    - 自动设置单元格格式，包括文本对齐、列宽和行高，实现美观的视觉呈现。
- **高度可配置**：支持自定义设置抓取的订单页数，灵活控制采集深度。

---

## 🚀 快速开始

### 1. 环境准备

本项目依赖 Python 3 环境。首先，请确保已安装所有必需的第三方库。建议在虚拟环境中执行此操作。

```bash
# 安装所有依赖
pip install -r requirements.txt
```

*`requirements.txt` 文件应包含以下内容:*
```
selenium-wire
webdriver-manager
pandas
xlsxwriter
Pillow
```

### 2. 配置

在运行主程序 `weidian-scraper.py` 之前，您需要进行两项关键配置：

#### a. 更新Cookie

打开 `weidian-scraper.py` 文件，找到文件末尾的 `if __name__ == "__main__":` 部分。将 `MY_COOKIE` 变量的值，替换为您从浏览器中获取的、最新的有效Cookie字符串。

```python
# weidian-scraper.py L250 (示例)
MY_COOKIE = ("在这里粘贴您最新的Cookie字符串...")
```

#### b. 设置抓取深度

在同一区域，修改 `CLICKS_TO_PERFORM` 变量的值，以控制需要抓取的订单页数。

- `0` 代表只抓取首页的订单。
- `1` 代表抓取首页 + 点击1次“加载更多”，共2页。
- `n` 代表抓取首页 + 点击n次“加载更多”，共 n+1 页。

```python
# weidian-scraper.py L253 (示例)
CLICKS_TO_PERFORM = 5 # 抓取6页订单
```

### 3. 运行程序

完成配置后，直接在命令行中运行主程序：

```bash
python weidian-scraper.py
```

程序执行完毕后，将在项目根目录下生成 `screenshots` 文件夹和 `微店订单导出.xlsx` 文件。

---

## 🛠️ 技术实现概览

本程序的核心工作流分为四个阶段：

1.  **Phase 1 & 2: JSON快速发现**
    - 程序首先模拟人类操作，通过访问“待发货”页再点击“全部”标签页的方式，稳定触发首页订单数据的XHR请求，并将其捕获。
    - 随后，根据用户配置的 `CLICKS_TO_PERFORM` 次数，循环点击“查看更多订单”按钮，并捕获后续所有页面的XHR请求。
    - 所有捕获到的JSON数据都被解析并存入`OrderData`对象列表中。

2.  **Phase 3: 精准截图**
    - 程序遍历已发现的订单列表，逐一访问每个订单的详情页URL。
    - 在详情页中，通过执行JavaScript将页面缩放至80%，确保所有关键信息能一次性完整显示。
    - 对包含所有信息的核心容器 `//*[@id="detail"]` 进行截图，并使用Pillow库对图片进行精加工（裁剪掉多余的空白区域）。

3.  **Phase 4: Excel生成**
    - 使用 `pandas` 将所有订单数据转换为DataFrame。
    - 使用 `xlsxwriter` 引擎将DataFrame写入Excel，并进行深度格式化：
        - 设置所有文本单元格为“垂直居中，水平左对齐”。
        - 为截图列设置一个固定的、足够宽的列宽。
        - 根据每张截图的实际宽高比，动态计算并设置完美的行高。
        - 将精加工后的截图嵌入文件，并设置为“随单元格移动和缩放”。

---

## 📝 后续操作建议

生成的 `微店订单导出.xlsx` 文件可以直接在 WPS Office 或 Microsoft Excel 中打开。

如需将截图转换为WPS的“单元格图片”以进行VLOOKUP等高级操作，请按照以下步骤进行批量转换：

1.  在WPS中打开文件。
2.  点击菜单栏 `开始` -> `查找和选择` -> `定位条件`。
3.  在弹出的对话框中选择 `对象` 并确定。
4.  在任意一张被选中的图片上右键，选择 `将图片置于单元格中`。

WPS将自动完成所有图片的转换和行高的最终适配。